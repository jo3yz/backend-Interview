## TCP连接的实质
建立 TCP 连接就是通信的双方需要对***Sockets（端口和IP）、窗口大小和初试序列号***达成共识，连接中的一对 Socket 是由互联网地址标志符和端口组成的，窗口大小主要用来做流控制，最后的序列号是用来追踪通信发起方发送的数据包序号，接收方可以通过序列号向发送方确认某个数据包的成功接收。

到这里，我们将原有的问题转换成了***『为什么需要通过三次握手才可以初始化 Sockets、窗口大小和初始序列号？』***

## 为什么不是两次
### 通过三次握手才能阻止重复历史连接的初始化
如果只有两次握手，连接的被动接受方并不知道哪次的SYN连接是已经过期的（也可能是由于网络环境迟到的），只有连接的主动发起方才有足够的上下文判断（通过ack==seq+1）。所以三次握手中引入了RST这个选项，如果收到的ack不满足条件的话，就终止这次握手。

这样的机制把连接是否要建立的最终决定权又还给了连接的主动发起方，因为只有发送方有足够的上下文来判断当前连接是否是错误的或者过期的。

### 通过三次握手才能对通信双方的初始序列号进行初始化
使用三次握手的重要的原因就是通信双方都需要获得一个用于发送信息的初始化序列号，两方都有***独立的序列号序列***，握手过程中双方需要把自己的序列号与通知对端。

Server和Client都必须确保自己的序列号成功的通知到了对方，所以握手的ack就是seq+1。如果TCP是四次握手，像这样：

```
Client ------------------- Server
|                               |
|----------csyn(cseq)---------->|
|<----ssyn(sseq)/ack(cseq+1)----|
|----------ack(sseq+1)--------->|
            三次握手

Client ------------------- Server
|                               |
|----------csyn(cseq)---------->|
|<---------ack(cseq+1)----------|
|-----------ssyn(sseq)--------->|
|----------ack(sseq+1)--------->|
            四次握手
```
是没问题的，因为这样做到了可靠的交换初始序列号（ISN），等待通信双方都获取到了自己期望的初始化序列号之后就可以开始通信了，由于TCP消息头的设计，我们可以将中间的两次通信合成一个，Server可以向Client同时发送ack和syn（带seq）消息，这也就帮助我们将四次通信减少至三次。